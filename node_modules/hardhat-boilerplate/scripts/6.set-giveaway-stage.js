const colors = require('colors');

const verifier = require('./verifier');
const stage = require('./moralis/setStage');
const utils = require('./utils');
const moralisUtils = require('./moralis/utils/moralisUtils');

async function main() {
  colors.enable();
  try {
    const [deployer] = await hre.ethers.getSigners();

    console.log(`Current Network: ${hre.network.name}`.cyan);
    console.log(`Connected with the account: ${deployer.address}`.cyan);
    console.log(`Account balance: ${await deployer.getBalance()}`.cyan);

    const giveawaySettings = utils.getGiveawaySettings();
    const contractsAddressesSettings = utils.getContractsAddressesSettings();
    const stageName = giveawaySettings.name;
    await verifier.askIsOk([moralisUtils.moralisSettings(), giveawaySettings, contractsAddressesSettings]);

    console.log('-------------Setting giveaway stage-------------'.green);
    const whitelistRows = utils.getCustomWhitelistFromFile(stageName, giveawaySettings.whitelistFilePath);

    await utils.setWhitelist(stageName);

    await utils.addRecordsToWhitelist(stageName, whitelistRows);

    const merkleRoot = await utils.buildMerkleTreeFor(stageName);

    await utils.setSignatures();

    await stage.setStage(
      {
        ...giveawaySettings,
        merkleRoot,
      },
      contractsAddressesSettings,
    );
    console.log('-------------Giveaway stage was set successfully-------------'.green);
  } catch (error) {
    console.error(error);
    throw error;
  }
}

main()
  .then(() => process.exit(0))
  .catch(() => {
    process.exit(1);
  });
