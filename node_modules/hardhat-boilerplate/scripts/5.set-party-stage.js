const hre = require('hardhat');
const colors = require('colors');
const dotenv = require('dotenv');
dotenv.config();

const moralisUtils = require('./moralis/utils/moralisUtils');
const { getCustomWhitelistFromFile, setWhitelist, addRecordsToWhitelist } = require('./utils');

async function setStageOnDb(stageName) {
  console.log('-------------Connecting with Moralis Server to set Stage-------------'.green);
  console.group();
  const options = { useMasterKey: true };
  await moralisUtils.initialize(options);
  await moralisUtils.updateStage(stageName, 0, options);
  await moralisUtils.setGeneratedTickets(options);
  console.groupEnd();
  console.log('-------------New stage set successfully-------------'.green);
}

async function main() {
  colors.enable();

  const stageName = 'party';
  try {
    const partySettings = hre.config.stages[stageName];

    console.log('-------------Setting party stage-------------'.green);
    console.table(partySettings);

    const whitelistRows = getCustomWhitelistFromFile(stageName, partySettings.whitelistFilePath, true);

    await setWhitelist(stageName);

    await addRecordsToWhitelist(stageName, whitelistRows);

    await setStageOnDb(stageName);

    console.log('-------------Party stage was set successfully-------------'.green);
  } catch (error) {
    console.error(error);
    throw error;
  }
}

main()
  .then(() => process.exit(0))
  .catch(() => {
    process.exit(1);
  });
