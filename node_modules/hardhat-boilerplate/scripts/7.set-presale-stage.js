const colors = require('colors');

const verifier = require('./verifier');
const moralisUtils = require('./moralis/utils/moralisUtils');
const stage = require('./moralis/setStage');
const utils = require('./utils');

async function main() {
  colors.enable();
  try {
    const [deployer] = await hre.ethers.getSigners();

    console.log(`Current Network: ${hre.network.name}`.cyan);
    console.log(`Connected with the account: ${deployer.address}`.cyan);
    console.log(`Account balance: ${await deployer.getBalance()}`.cyan);
    const preSaleSettings = utils.getPresaleSettings();

    const contractsAddressesSettings = utils.getContractsAddressesSettings();
    const stageName = preSaleSettings.name;
    await verifier.askIsOk([moralisUtils.moralisSettings(), preSaleSettings, contractsAddressesSettings]);

    console.log('-------------Setting Pre-Sale stage-------------'.green);
    const whitelistRows = utils.getCustomWhitelistFromFile(stageName, preSaleSettings.whitelistFilePath, true);

    await utils.addRecordsToWhitelist(stageName, whitelistRows);

    const merkleRoot = await utils.buildMerkleTreeFor(stageName);

    await stage.setStage(
      {
        ...preSaleSettings,
        merkleRoot,
      },
      contractsAddressesSettings,
    );
    console.log('-------------Pre-Sale stage was set successfully-------------'.green);
  } catch (error) {
    console.error(error);
    throw error;
  }
}

main()
  .then(() => process.exit(0))
  .catch(() => {
    process.exit(1);
  });
